<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palmöl: Die Wahrheit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Zusätzliches benutzerdefiniertes Styling */
        body {
            background-color: #f7fafc;
        }
        .correct {
            background-color: #d1fae5; /* Hellgrün */
            border-color: #10b981; /* Dunkelgrün */
            color: #065f46; /* Dunkelgrüner Text */
            font-weight: bold;
        }
        .incorrect {
            background-color: #fee2e2; /* Hellrot */
            border-color: #ef4444; /* Dunkelrot */
            color: #991b1b; /* Dunkelroter Text */
            opacity: 0.6; /* Macht falsche Antworten etwas blasser */
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-primary:disabled {
            background-color: #a5b4fc;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="p-4">

    <div class="max-w-3xl mx-auto bg-white p-6 md:p-10 shadow-xl rounded-xl mt-6">
        
        <header class="text-center mb-8">
            <h1 id="quiz-title-display" class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-2">Quiz Titel</h1>
            <p id="quiz-description-display" class="text-gray-600 text-lg">Beantworte die Fragen und knacke den Highscore</p>
        </header>

        <div id="stats-container" class="hidden flex justify-between items-center bg-indigo-100 p-4 rounded-lg mb-6 shadow">
            <div class="text-center">
                <span id="question-counter" class="text-xl font-bold text-indigo-700">0/10</span>
                <p class="text-sm text-indigo-500">Frage</p>
            </div>
            <div class="text-center">
                <span id="score-display" class="text-xl font-bold text-green-600">0</span>
                <p class="text-sm text-indigo-500">Punkte</p>
            </div>
            <div class="text-center">
                <span id="timer-display" class="text-xl font-bold text-gray-700">00:00</span>
                <p class="text-sm text-indigo-500">Zeit</p>
            </div>
        </div>

        <div id="start-screen" class="text-center p-8">
            <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 rounded-md" role="alert">
                <p class="font-bold">Hinweis:</p>
                <p>Um deinen Highscore zu speichern, meldet sich das Quiz automatisch anonym bei Firebase an. Ihr Benutzername wird **öffentlich** geteilt.</p>
            </div>
            <button id="start-button" class="btn-primary" disabled>
                Lade Firebase-Dienste...
            </button>
            <div class="mt-8">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Top 10 Bestenliste</h3>
                <ul id="leaderboard-list" class="space-y-2 text-left p-4 border rounded-lg">
                    <li class="text-gray-500 italic">Wird geladen...</li>
                </ul>
            </div>
        </div>

        <div id="question-screen" class="hidden">
            <p id="question-text" class="text-2xl font-semibold mb-6 text-gray-800">Fragentext</p>

            <div id="options-container" class="space-y-4 mb-6">
                </div>

            <div id="feedback-container" class="hidden p-4 rounded-lg mt-4" role="alert">
                <p id="feedback-text" class="font-bold mb-2 text-lg"></p>
                <p id="rationale-text" class="text-sm"></p>
            </div>

            <button id="next-button" class="btn-primary w-full mt-6 hidden">
                Nächste Frage
            </button>
        </div>

        <div id="result-screen" class="hidden text-center p-8">
            <h2 class="text-3xl font-bold text-indigo-700 mb-4">Quiz beendet!</h2>
            <p class="text-xl text-gray-700 mb-2">Dein Score: <span id="final-score" class="font-bold text-green-600">0</span> Punkte</p>
            <p class="text-xl text-gray-700 mb-6">Deine Zeit: <span id="final-time" class="font-bold text-gray-700" data-seconds="0">00:00</span></p>
            
            <div class="mt-8 p-4 bg-gray-50 rounded-lg">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Trage dich in die Bestenliste ein</h3>
                <input type="text" id="username-input" placeholder="Dein Benutzername (max. 20 Zeichen)" maxlength="20" class="w-full p-3 border border-gray-300 rounded-lg mb-4 text-center">
                <button id="submit-score-button" class="btn-primary w-full mb-4">Score speichern</button>
            </div>

            <button id="restart-button" class="mt-4 text-indigo-600 hover:text-indigo-800 font-medium">
                Quiz neu starten
            </button>

            <div class="mt-8">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Top 10 Bestenliste</h3>
                <ul id="leaderboard-list" class="space-y-2 text-left p-4 border rounded-lg">
                    </ul>
            </div>
        </div>

    </div>

<!-- Firebase Kompatibilitäts-CDNs (beheben den eval()-Fehler) -->
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

<script>
    // === QUIZ DYNAMISCHE DATEN ===
    const appId = 'palmoel_quiz_1';
    
    // Konfiguration für den Fall, dass die App lokal ausgeführt wird (außerhalb des Canvas-Tools).
    const DEFAULT_FIREBASE_CONFIG = {
        apiKey: "AIzaSyDY9Va_wf2Kj4LREi2jd9_g9H4bts1tygc",
        authDomain: "quizgenerator-ff451.firebaseapp.com",
        projectId: "quizgenerator-ff451",
        storageBucket: "quizgenerator-ff451.firebasestorage.app",
        messagingSenderId: "396720876641",
        appId: "1:396720876641:web:700fa550a6129ad06f4e20"
    };

    // Wählt die Konfiguration: Canvas-Tool-Konfig > Lokale Standardkonfig
    let firebaseConfigToUse = DEFAULT_FIREBASE_CONFIG;
    let initialAuthToken = null;
    let appIdOverride = appId;

    if (typeof __firebase_config !== 'undefined') {
        try {
            firebaseConfigToUse = JSON.parse(__firebase_config);
        } catch (e) {
            console.error("Fehler beim Parsen von __firebase_config:", e);
        }
    }
    if (typeof __app_id !== 'undefined') {
        appIdOverride = __app_id;
    }
    if (typeof __initial_auth_token !== 'undefined') {
        initialAuthToken = __initial_auth_token;
    }
    
    // Das eigentliche Quiz-Daten-Array
    const quizData = [
        {
            question: "Was ist die Hauptursache für die Bedrohung der Orang-Utans laut Video?",
            options: [
                { text: "Die Ausbreitung von Krankheiten durch Kontakt mit Menschen.", correct: false },
                { text: "Illegale Jagd und Wilderei.", correct: false },
                { text: "Die Rodung von Regenwald für Palmölplantagen.", correct: true },
                { text: "Übermäßige Trockenheit durch Klimawandel.", correct: false }
            ],
            rationale: "Die Umwandlung von uraltem Regenwald in Plantagen zerstört den Lebensraum der Tiere am schnellsten und umfassendsten."
        },
        {
            question: "Wie viel Prozent der globalen Palmölproduktion liefern Indonesien und Malaysia etwa?",
            options: [
                { text: "65 Prozent", correct: false },
                { text: "95 Prozent", correct: false },
                { text: "50 Prozent", correct: false },
                { text: "85 Prozent", correct: true }
            ],
            rationale: "Diese beiden Länder sind die primären Produzenten und machen den Großteil des weltweiten Angebots aus."
        },
        {
            question: "Was ist ein Hauptgrund dafür, dass Palmöl in der Lebensmittelindustrie so beliebt ist?",
            options: [
                { text: "Es hat einen besonders hohen Anteil an Omega-3-Fettsäuren.", correct: false },
                { text: "Es ist hitzebeständig, geruchsneutral und billig.", correct: true },
                { text: "Es ist das einzige Öl, das die Textur von Schokolade perfekt macht.", correct: false },
                { text: "Es kann nur in Europa nachhaltig produziert werden.", correct: false }
            ],
            rationale: "Die Kombination aus Kosten, Stabilität, und Neutralität macht es industriell für eine breite Palette von Produkten wertvoll."
        },
        {
            question: "Wie hat sich die Zahl der frei lebenden Orang-Utans in den vergangenen anderthalb Jahrzehnten laut Video ungefähr verändert?",
            options: [
                { text: "Die Zahl ist stabil geblieben, aber der Lebensraum schrumpft.", correct: false },
                { text: "Von ca. 100.000 auf ca. 80.000 abgenommen.", correct: false },
                { text: "Von ca. 200.000 auf ca. 50.000 abgenommen.", correct: true },
                { text: "Von ca. 50.000 auf ca. 15.000 abgenommen.", correct: false }
            ],
            rationale: "Die dramatische Abnahme der Population auf etwa ein Viertel der ursprünglichen Zahl wird im Video als Folge der Habitatzerstörung genannt."
        },
        {
            question: "Warum würde ein einfacher Boykott von Palmöl laut Dirk Steffens wahrscheinlich nicht die Lösung sein?",
            options: [
                { text: "Weil Palmöl das einzige Öl ist, das im menschlichen Körper abgebaut werden kann.", correct: false },
                { text: "Weil die Alternativen (Raps, Soja) viel weniger Ertrag pro Hektar liefern und mehr Fläche benötigen würden.", correct: true },
                { text: "Weil Palmölplantagen wichtige CO2-Speicher sind, die sonst verloren gingen.", correct: false },
                { text: "Weil Palmöl nur in Ländern angebaut wird, die keine anderen Einkommensquellen haben.", correct: false }
            ],
            rationale: "Aufgrund des geringeren Ertrags von Alternativen müsste mehr Land für diese anderen Öle gerodet werden, was das Problem nur verlagern würde."
        },
        {
            question: "Wie viel Öl pro Jahr und Hektar produziert eine Palmölplantage ungefähr, im Vergleich zu Raps, Soja oder Sonnenblumen?",
            options: [
                { text: "Ungefähr die Hälfte.", correct: false },
                { text: "Etwa 20% mehr.", correct: false },
                { text: "Drei- bis viermal so viel.", correct: true },
                { text: "Genau die gleiche Menge.", correct: false }
            ],
            rationale: "Die Ölpalme ist extrem ertragreich, was sie sehr effizient macht und die Konkurrenz mit anderen Ölsorten schwer. Sie produziert dreieinhalb Tonnen Öl pro Hektar und Jahr, Alternativen etwa ein Drittel davon."
        },
        {
            question: "Was passiert häufig mit jungen Orang-Utans, deren Mütter auf Palmölplantagen eindringen, um die jungen Sprossen zu fressen?",
            options: [
                { text: "Sie werden von ihrer Mutter getrennt und verenden oft.", correct: true },
                { text: "Sie werden sofort in Zoos in Europa gebracht.", correct: false },
                { text: "Sie passen sich schnell an die Plantage als neuen Lebensraum an.", correct: false },
                { text: "Sie werden von den Plantagenarbeitern aufgezogen und trainiert.", correct: false }
            ],
            rationale: "Die Trennung von der Mutter ist die häufigste und tragischste Folge des Eindringens in Plantagen, was ohne menschliche Hilfe oft tödlich endet."
        },
        {
            question: "Was schlägt Dirk Steffens als praktische Maßnahme gegen die Palmöl-Problematik vor?",
            options: [
                { text: "Ausschließlich Palmöl aus nachhaltigem Anbau konsumieren und weniger Fertignahrung essen.", correct: true },
                { text: "Die gesamte Ölproduktion in unterirdische Plantagen verlegen.", correct: false },
                { text: "Der Politik verbieten, Palmöl überhaupt noch zu importieren.", correct: false },
                { text: "Weltweit alle Ölpalmen durch Sonnenblumen ersetzen.", correct: false }
            ],
            rationale: "Da ein Totalboykott nicht sinnvoll ist, ist die beste Strategie bewusstes Konsumieren von nachhaltigem Palmöl und die Reduzierung von Fertignahrungsmitteln, in denen viel davon steckt."
        },
        {
            question: "In wie vielen Supermarktprodukten steckt Palmöl, laut der Aussage im Video, ungefähr?",
            options: [
                { text: "Ausschließlich in Süßigkeiten und Chips.", correct: false },
                { text: "In jedem zehnten Produkt.", correct: false },
                { text: "In jedem zweiten Produkt.", correct: true },
                { text: "In weniger als 5% aller Produkte.", correct: false }
            ],
            rationale: "Palmöl ist aufgrund seiner vielfältigen industriellen Eigenschaften und des niedrigen Preises in einer extrem hohen Anzahl von Konsumgütern enthalten."
        },
        {
            question: "Welche Fläche des uralten Regenwaldes ging in Indonesien laut Video allein in den vergangenen drei Jahrzehnten verloren?",
            options: [
                { text: "Die Hälfte aller Flüsse und Seen.", correct: false },
                { text: "Ein Drittel der Fläche des uralten Regenwaldes.", correct: true },
                { text: "Die gesamte Fläche von Sumatra.", correct: false },
                { text: "Ein Zehntel der gesamten Insel Borneo.", correct: false }
            ],
            rationale: "Die Zerstörung des Regenwaldes ist massiv, wobei ein Drittel der Fläche in nur 30 Jahren für Plantagen gerodet wurde."
        }
    ];
    
    document.getElementById('quiz-title-display').textContent = 'Palmöl: Die Wahrheit';
    document.getElementById('quiz-description-display').textContent = 'Beantworte die Fragen und knacke den Highscore';
    document.title = 'Palmöl: Die Wahrheit';


    // === Globale Zustände & Firebase-Initialisierung ===
    let app;
    let auth;
    let db;
    let currentUser = null;

    let currentQuestionIndex = 0;
    let score = 0;
    let timerInterval;
    let totalSeconds = 0;
    let quizActive = false;
    let userHasSubmitted = false;
    
    const questionText = document.getElementById('question-text');
    const optionsContainer = document.getElementById('options-container');
    const nextButton = document.getElementById('next-button');
    const startButton = document.getElementById('start-button');
    const feedbackContainer = document.getElementById('feedback-container');
    const feedbackText = document.getElementById('feedback-text');
    const rationaleText = document.getElementById('rationale-text');
    const timerDisplay = document.getElementById('timer-display');
    const scoreDisplay = document.getElementById('score-display');
    const questionCounter = document.getElementById('question-counter');
    const statsContainer = document.getElementById('stats-container');
    const startScreen = document.getElementById('start-screen');
    const questionScreen = document.getElementById('question-screen');
    const resultScreen = document.getElementById('result-screen');
    const finalScoreDisplay = document.getElementById('final-score');
    const finalTimeDisplay = document.getElementById('final-time');
    const usernameInput = document.getElementById('username-input');
    const submitScoreButton = document.getElementById('submit-score-button');
    const restartButton = document.getElementById('restart-button');


    async function initializeFirebase() {
        try {
            // FIX: Verwenden der vorbereiteten Konfiguration
            // Initialisiert die App mit der korrekten Konfiguration
            app = firebase.initializeApp(firebaseConfigToUse);
            // Nutzt die globalen compatibility-Objekte
            auth = app.auth();
            db = app.firestore();
            
            // Anmelde-Logik
            if (initialAuthToken) {
                // Bei Canvas-Ausführung wird dieser Pfad verwendet
                await auth.signInWithCustomToken(initialAuthToken); 
            } else {
                // Bei lokaler Ausführung wird dieser Pfad verwendet (anonyme Anmeldung)
                await auth.signInAnonymously();
            }
            
            listenForAuth();
            loadLeaderboard();
        } catch (error) {
            console.error("Firebase Initialisierungsfehler:", error);
            document.getElementById('quiz-description-display').textContent = "Fehler: Firebase-Dienste konnten nicht initialisiert werden (Siehe Konsole).";
            startButton.textContent = "Fehler (Siehe Konsole)";
        }
    }

    function listenForAuth() {
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                console.log("Firebase-Anmeldung erfolgreich:", user.uid);
                startButton.disabled = false;
                startButton.textContent = "Starte das Quiz";
                usernameInput.value = localStorage.getItem('quizUsername') || '';
            }
        });
    }

    // === Timer Funktionen ===
    function startTimer() {
        totalSeconds = 0;
        updateTimerDisplay();
        timerInterval = setInterval(() => {
            totalSeconds++;
            updateTimerDisplay();
        }, 1000);
    }

    function stopTimer() {
        clearInterval(timerInterval);
    }

    function updateTimerDisplay() {
        const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
        const seconds = String(totalSeconds % 60).padStart(2, '0');
        timerDisplay.textContent = `${minutes}:${seconds}`;
    }

    // === Quiz Logik ===
    function startQuiz() {
        currentQuestionIndex = 0;
        score = 0;
        totalSeconds = 0;
        quizActive = true;
        userHasSubmitted = false;

        startScreen.classList.add('hidden');
        resultScreen.classList.add('hidden');
        questionScreen.classList.remove('hidden');
        statsContainer.classList.remove('hidden');
        submitScoreButton.disabled = false;
        submitScoreButton.textContent = "Score speichern";
        
        scoreDisplay.textContent = score;
        questionCounter.textContent = `${currentQuestionIndex}/${quizData.length}`;
        
        startTimer();
        showQuestion();
    }

    function showQuestion() {
        if (currentQuestionIndex >= quizData.length) {
            endQuiz();
            return;
        }

        const currentQuestion = quizData[currentQuestionIndex];
        questionText.textContent = currentQuestion.question;
        optionsContainer.innerHTML = '';
        nextButton.classList.add('hidden');
        feedbackContainer.classList.add('hidden');
        questionCounter.textContent = `${currentQuestionIndex + 1}/${quizData.length}`;

        currentQuestion.options.forEach((option, index) => {
            const button = document.createElement('button');
            button.textContent = option.text;
            button.classList.add('btn-option', 'w-full', 'p-3', 'text-left', 'border', 'border-gray-300', 'rounded-lg', 'text-gray-700', 'bg-white', 'hover:bg-indigo-50', 'transition', 'duration-200');
            button.dataset.index = index;
            button.onclick = () => selectAnswer(button, option.correct, currentQuestion.rationale);
            optionsContainer.appendChild(button);
        });
    }

    function selectAnswer(selectedButton, isCorrect, rationale) {
        if (!quizActive) return;

        // Deaktiviere alle Buttons
        Array.from(optionsContainer.children).forEach(button => {
            button.disabled = true;
            if (button.dataset.index !== selectedButton.dataset.index) {
                button.classList.remove('hover:bg-indigo-50');
            }
        });

        // Feedback anzeigen
        feedbackContainer.classList.remove('hidden');
        rationaleText.textContent = rationale ? `Begründung: ${rationale}` : '';

        if (isCorrect) {
            score++;
            scoreDisplay.textContent = score;
            selectedButton.classList.add('correct');
            feedbackText.textContent = "Richtig! Gut gemacht.";
        } else {
            selectedButton.classList.add('incorrect');
            feedbackText.textContent = "Falsch. Die richtige Antwort ist markiert.";
            // Markiere die korrekte Antwort
            Array.from(optionsContainer.children).forEach(button => {
                if (quizData[currentQuestionIndex].options[button.dataset.index].correct) {
                    button.classList.add('correct');
                }
            });
        }

        // Nächste-Frage-Button anzeigen
        nextButton.disabled = false;
        nextButton.classList.remove('hidden');
    }

    function nextQuestion() {
        currentQuestionIndex++;
        nextButton.classList.add('hidden');
        if (currentQuestionIndex < quizData.length) {
            showQuestion();
        } else {
            endQuiz();
        }
    }

    function endQuiz() {
        stopTimer();
        quizActive = false;
        
        questionScreen.classList.add('hidden');
        statsContainer.classList.add('hidden');
        resultScreen.classList.remove('hidden');

        const timeString = timerDisplay.textContent;
        
        finalScoreDisplay.textContent = score;
        finalTimeDisplay.textContent = timeString;
        document.getElementById('final-time').dataset.seconds = totalSeconds;

        // Standardname setzen, falls vorhanden
        const storedUsername = localStorage.getItem('quizUsername');
        if (storedUsername) {
            usernameInput.value = storedUsername;
        }
    }

    // === Bestenliste Logik ===
    function getLeaderboardPath() {
        return `artifacts/${appIdOverride}/public/data/leaderboard-scores`;
    }

    function loadLeaderboard() {
        if (!db) return;

        const leaderboardRef = db.collection(getLeaderboardPath());
        
        // FIX: Sortiert primär nach Score in Firestore, um das Indexproblem zu umgehen.
        // Die sekundäre Sortierung nach Zeit und das Limit werden in JavaScript durchgeführt.
        const q = leaderboardRef.orderBy("score", "desc").limit(20);

        // onSnapshot wird verwendet, um in Echtzeit auf Änderungen zu reagieren
        q.onSnapshot((snapshot) => {
            let scores = [];
            snapshot.forEach((doc) => {
                scores.push(doc.data());
            });

            // Lokale Sortierung:
            // Primär nach Score (absteigend) und Sekundär nach Zeit (aufsteigend)
            scores.sort((a, b) => {
                // Hauptkriterium: Score (absteigend)
                if (a.score !== b.score) {
                    return b.score - a.score;
                }
                // Sekundärkriterium: Zeit (aufsteigend)
                return a.time - b.time;
            });
            
            // Lokale Limitierung auf Top 10
            const topScores = scores.slice(0, 10);

            const leaderboardListElement = startScreen.querySelector('#leaderboard-list') || resultScreen.querySelector('#leaderboard-list');
            
            if (!leaderboardListElement) return;

            leaderboardListElement.innerHTML = '';

            if (topScores.length === 0) {
                leaderboardListElement.innerHTML = '<li class="text-gray-500 italic">Noch keine Highscores. Sei der Erste!</li>';
                return;
            }
            
            topScores.forEach((data, index) => {
                const timeSecs = data.time || 0;
                const minutes = String(Math.floor(timeSecs / 60)).padStart(2, '0');
                const seconds = String(timeSecs % 60).padStart(2, '0');
                const timeFormatted = `${minutes}:${seconds}`;

                const li = document.createElement('li');
                li.classList.add('flex', 'justify-between', 'items-center', 'p-2', 'rounded');
                
                let rankClass = 'text-gray-700 font-medium';
                if (index === 0) rankClass = 'text-amber-500 font-bold text-lg';
                else if (index === 1) rankClass = 'text-slate-500 font-bold';
                else if (index === 2) rankClass = 'text-yellow-600 font-bold';

                li.innerHTML = `
                    <span class="${rankClass}">${index + 1}. ${data.username || 'Anonym'}</span>
                    <span class="${rankClass}">
                        ${data.score} Pkt. <span class="text-sm text-gray-500 ml-2">${timeFormatted}</span>
                    </span>
                `;
                leaderboardListElement.appendChild(li);
            });
        }, (error) => {
            console.error("Fehler beim Laden der Bestenliste:", error);
            const leaderboardListElement = startScreen.querySelector('#leaderboard-list') || resultScreen.querySelector('#leaderboard-list');
            if (leaderboardListElement) {
                 leaderboardListElement.innerHTML = '<li class="text-red-500">Fehler beim Laden der Bestenliste.</li>';
            }
        });
    }

    async function submitScore() {
        if (userHasSubmitted) return;
        if (!currentUser || !db) {
             console.error("Benutzer oder DB nicht bereit.");
             submitScoreButton.textContent = "Fehler (Neu laden)";
             return;
        }

        const username = usernameInput.value.trim();
        if (username.length < 2 || username.length > 20) {
             console.error("Ungültiger Benutzername.");
             const originalPlaceholder = usernameInput.placeholder;
             usernameInput.placeholder = "2-20 Zeichen benötigt!";
             usernameInput.focus();
             setTimeout(() => { usernameInput.placeholder = originalPlaceholder; }, 3000);
             return;
        }

        localStorage.setItem('quizUsername', username);

        submitScoreButton.disabled = true;
        submitScoreButton.textContent = "Speichere...";

        const scoreData = {
            username: username,
            score: score,
            time: totalSeconds, // Speichert die Zeit in Sekunden
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            userId: currentUser.uid 
        };
        
        try {
            // Fügt ein neues Dokument in der öffentlichen Sammlung hinzu
            await db.collection(getLeaderboardPath()).add(scoreData);

            userHasSubmitted = true;
            submitScoreButton.textContent = "Gespeichert!";

        } catch (error) {
            console.error("Fehler beim Speichern des Scores:", error);
            submitScoreButton.disabled = false;
            submitScoreButton.textContent = "Speichern fehlgeschlagen";
        }
    }

    // === Event-Listener ===
    startButton.addEventListener('click', startQuiz);
    nextButton.addEventListener('click', nextQuestion);
    submitScoreButton.addEventListener('click', submitScore);
    restartButton.addEventListener('click', () => {
        resultScreen.classList.add('hidden');
        startScreen.classList.remove('hidden');
        // Laden der Bestenliste wird über onSnapshot automatisch ausgelöst
        clearInterval(timerInterval);
    });


    // === INITIALISIERUNG ===
    if (quizData.length === 0) {
        questionText.textContent = "Fehler: Es sind keine Fragen geladen. Bitte überprüfen Sie das Quiz-Daten-Array.";
        startButton.disabled = true;
    }

    // Stellt sicher, dass Firebase erst nach dem Laden des gesamten DOM initialisiert wird.
    document.addEventListener('DOMContentLoaded', initializeFirebase);
    
</script>
</body>
</html>
